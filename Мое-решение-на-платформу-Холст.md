# Мое решение на платформу «Холст»

## Введение

Платформа «Холст» представляет собой инновационную веб-приложение для визуального управления задачами, заметками и связями в бесконечном холсте. Основная цель — объединить планирование, управление знаниями и визуальное мышление в единой автономной среде, работающей без подключения к интернету.

На основе анализа технического задания (ТЗ) и архитектурного плана, я разработал полное решение, учитывающее все требования и предлагающее улучшения для повышения эффективности, безопасности и расширяемости системы.

## Архитектура

### Общая архитектура системы

Система построена на микросервисной архитектуре с использованием Docker для контейнеризации. Основные компоненты:

- **Frontend**: Vue.js 3 с Konva.js для бесконечного холста
- **Backend**: FastAPI на Python с SQLAlchemy ORM
- **Database**: PostgreSQL для хранения данных
- **Services**: Отдельные сервисы для STT (Vosk), экспорта (WeasyPrint)
- **Proxy**: Nginx как reverse proxy

Архитектура обеспечивает:
- Автономность (работа без интернета)
- Масштабируемость
- Модульность компонентов
- Высокую производительность

### Детализация компонентов

#### Frontend (Vue.js 3 + Konva.js)
- **Библиотеки**: Konva.js, Cytoscape.js, Tiptap, interact.js
- **Функции**: 
  - Бесконечный холст с масштабированием
  - Перетаскивание элементов
  - WYSIWYG-редактор
  - Графовая визуализация связей
  - Touch-оптимизация для мобильных устройств

#### Backend (FastAPI)
- **Слои**:
  - API Layer: REST эндпоинты
  - Business Logic: Валидация, транзакции
  - Data Access: SQLAlchemy ORM
  - Services: Поиск, экспорт, STT, проверка циклов

#### База данных (PostgreSQL)
- **Таблицы**:
  - `cards`: Задачи и подзадачи
  - `notes`: Заметки
  - `files`: Метаданные файлов
  - `task_links`: Связи задач
  - `note_links`: Связи заметок
  - `event_log`: История изменений

#### Сервисы
- **Voice STT**: Vosk для оффлайн распознавания речи
- **Export**: WeasyPrint для генерации PDF
- **Search**: Full-text search через PostgreSQL

## API

### Основные эндпоинты

#### Холст
- `GET /api/canvas` - Получение состояния холста

#### Задачи
- `POST /api/cards` - Создание задачи
- `PUT /api/cards/{id}` - Обновление задачи
- `DELETE /api/cards/{id}` - Удаление задачи

#### Заметки
- `POST /api/notes` - Создание заметки
- `PUT /api/notes/{id}` - Обновление заметки
- `GET /api/notes/{id}/export?format=markdown|pdf` - Экспорт заметки

#### Связи
- `POST /api/task-links` - Создание связи задач
- `DELETE /api/task-links/{id}` - Удаление связи задач
- `POST /api/note-links` - Создание связи заметок
- `DELETE /api/note-links/{id}` - Удаление связи заметок

#### Файлы
- `POST /api/cards/{id}/files` - Загрузка файла
- `GET /api/files/{id}/download` - Скачивание файла

#### Поиск
- `GET /api/search?q=...` - Поиск по контенту

#### Голос
- `POST /api/voice/transcribe` - Распознавание речи

#### Граф
- `GET /api/graph` - Получение структуры графа

#### История
- `POST /api/history/undo` - Отмена действия
- `POST /api/history/redo` - Повтор действия

## Данные

### Модели данных

#### Card (Задача)
```python
class Card(Base):
    id: str
    title: str
    content: JSON
    x: int
    y: int
    width: int
    height: int
    parent_id: Optional[str]  # Для иерархии
    canvas_id: str
    created_at: datetime
    updated_at: datetime
```

#### Note (Заметка)
```python
class Note(Base):
    id: str
    title: str
    content: JSON
    card_id: Optional[str]  # Привязка к задаче
    x: int
    y: int
    canvas_id: str
    created_at: datetime
    updated_at: datetime
```

#### TaskLink (Связь задач)
```python
class TaskLink(Base):
    id: int
    source_id: str
    target_id: str
    type: str  # depends_on, blocks, follows, related_to
    canvas_id: str
```

#### NoteLink (Связь заметок)
```python
class NoteLink(Base):
    id: int
    source_id: str
    target_id: str
    canvas_id: str
```

#### File (Файл)
```python
class File(Base):
    id: str
    filename: str
    original_name: str
    mime_type: str
    size: int
    card_id: Optional[str]
    note_id: Optional[str]
    path: str
    canvas_id: str
    uploaded_at: datetime
```

#### EventLog (История)
```python
class EventLog(Base):
    id: int
    action: str
    entity_type: str
    entity_id: str
    old_data: JSON
    new_data: JSON
    timestamp: datetime
    canvas_id: str
```

## UI/UX

### Дизайн интерфейса

#### Основной холст
- Бесконечное пространство с сеткой
- Масштабирование колесом мыши
- Панорамирование перетаскиванием
- Адаптивность для мобильных устройств

#### Панель инструментов
- Кнопки: Добавить задачу, заметку, связь
- Поисковое поле
- Кнопки экспорта и настроек
- Режим графа

#### Карточки задач
- Прямоугольники с заголовком и содержимым
- Перетаскивание по холсту
- Сворачивание/разворачивание подзадач
- Контекстное меню

#### Заметки
- WYSIWYG-редактор с Tiptap
- Поддержка таблиц, изображений, ссылок
- Привязка к задачам
- Свободное размещение

#### Граф связей
- Отдельный режим просмотра
- Интерактивная визуализация
- Фильтрация и поиск
- Переход к элементам на холсте

### UX принципы
- Интуитивное управление
- Быстрые клавиши (Ctrl+Z, Ctrl+Y)
- Touch-оптимизация
- Адаптивный дизайн
- Минималистичный интерфейс

## Развертывание

### Инфраструктура

#### Docker Compose
```yaml
services:
  db:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: holst
      POSTGRES_USER: holst
      POSTGRES_PASSWORD: holst

  backend:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./data:/data
    depends_on:
      - db

  voice-stt:
    build: ./voice-stt
    environment:
      - MODEL_PATH=/models/vosk-model-small-ru

  nginx:
    build: ./nginx
    ports:
      - "80:80"
    depends_on:
      - backend
      - voice-stt

volumes:
  postgres_data:
  uploads:
```

#### Процесс развертывания
1. Клонирование репозитория
2. Скачивание зависимостей локально
3. Сборка образов Docker
4. Запуск через docker-compose
5. Инициализация базы данных
6. Настройка volume для файлов

#### Требования к системе
- Docker и Docker Compose
- Минимум 4GB RAM
- 10GB свободного места
- Поддержка AVX для Vosk

## Расширения

### Пользователи и аутентификация
- Добавление модели User
- JWT-аутентификация
- Ролевая модель (admin, user)
- Многохолстовая поддержка
- Совместная работа через WebSocket

### ИИ-интеграция

#### Интеграция OpenRouter API
- **Доступ к множеству моделей**: OpenRouter предоставляет единый API для доступа к различным ИИ-моделям, включая GPT-4 (OpenAI), Claude (Anthropic), Gemini (Google) и другие.
- **Роутинг запросов**: Автоматическая балансировка нагрузки и роутинг запросов к оптимальным провайдерам на основе доступности, стоимости и производительности.
- **Генерация контента**: Использование ИИ для создания заметок, описаний задач и автоматического наполнения контента на основе существующих данных.
- **Анализ зависимостей**: ИИ анализирует связи между задачами и заметками, выявляет скрытые зависимости и предлагает оптимизацию рабочих процессов.
- **Автоматическое связывание**: Интеллектуальное создание связей между заметками и задачами на основе семантического анализа контента, ключевых слов и контекста.
- **Умный поиск и рекомендации**: Улучшенный поиск с использованием ИИ для понимания запросов на естественном языке и предоставления релевантных рекомендаций.
- **Автоматическое тэгирование**: ИИ присваивает теги элементам на основе их содержания для лучшей организации и поиска.

#### Преимущества
- **Доступ к множеству моделей**: Возможность выбора наиболее подходящей модели для конкретной задачи (например, GPT-4 для генерации текста, Claude для анализа).
- **Балансировка нагрузки**: OpenRouter автоматически распределяет запросы между провайдерами для обеспечения стабильности и снижения стоимости.
- **Гибкость**: Легкая смена моделей без изменения кода приложения, возможность экспериментировать с разными подходами.

#### Ограничения
- **Зависимость от интернета**: Требуется подключение к интернету для отправки запросов к OpenRouter API.
- **Стоимость API**: Платные запросы к внешним провайдерам, что может увеличить расходы при интенсивном использовании.
- **Потенциальные задержки**: Зависимость от скорости интернет-соединения и нагрузки на сервисы провайдеров.

#### Сочетание с оффлайн-работой
- **Кэширование результатов**: Опциональное локальное кэширование ответов ИИ для повторного использования без повторных запросов.
- **Гибридный режим**: Приоритет локальным LLM (Ollama, LM Studio) для оффлайн-работы, с fallback на OpenRouter при необходимости.
- **Оффлайн-анализ**: Локальная обработка простых задач анализа зависимостей и связывания, с использованием ИИ только для сложных случаев.

### Безопасность
- Шифрование чувствительных данных
- Rate limiting для API
- Аудит логов
- Защита от XSS и CSRF
- Безопасное хранение файлов

### Мобильная оптимизация
- PWA (Progressive Web App)
- Оффлайн-синхронизация
- Оптимизированные touch-интерфейсы
- Push-уведомления
- Синхронизация между устройствами

### Дополнительные улучшения
- Темная тема
- Кастомизация интерфейса
- Плагины и расширения
- Экспорт в различные форматы
- Интеграция с внешними сервисами

## Заключение

Предложенное решение полностью соответствует требованиям ТЗ и архитектурного плана, с дополнительными улучшениями для повышения качества и расширяемости системы.

### Ключевые преимущества:
- **Автономность**: Полная работа без интернета
- **Производительность**: Оптимизированная архитектура
- **Безопасность**: Многоуровневая защита данных
- **Расширяемость**: Модульная архитектура для будущих улучшений
- **UX**: Интуитивный и адаптивный интерфейс

### Рекомендации по реализации:
1. Начать с MVP: базовый холст, задачи, заметки
2. Постепенно добавлять связи и граф
3. Реализовать поиск и экспорт
4. Добавить голосовой ввод и историю
5. Внедрить расширения поэтапно

Это решение готово к практической реализации и дальнейшему развитию.